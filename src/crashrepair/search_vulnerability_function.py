import json
import os
import typing as t
from LLMrepair import get_function_from_file

data_dir = '/data/vulnloc/'
project = os.listdir(data_dir)
vul_function: t.Dict[str, t.Dict[str, t.List]] = {}
for p_id in project:
    if not os.path.isdir(os.path.join(data_dir, p_id)):
        continue
    vul_id = os.listdir(os.path.join(data_dir, p_id))
    for v_id in vul_id:
        if not os.path.isdir(os.path.join(data_dir, p_id, v_id)):
            continue
        vul_dir = os.path.join(data_dir, p_id, v_id)
        location_path = os.path.join(vul_dir, 'analysis', 'localization.json')
        if not os.path.exists(location_path):
            continue
        with open(location_path, "r", encoding='utf-8') as fh:
            localization = json.loads(fh.read())
        for i in localization:
            vulnerable_file_path = i['location'].split(':')[0]
            line_number = int(i['location'].split(':')[1])
            # token_number = int(i['location'].split(':')[2])
            results = get_function_from_file(vulnerable_file_path, line_number)
            if results:
                start_line = results[0]
                end_line = results[1]
                function = results[2]
                vulnerable_line = results[3]  # 代表漏洞代码语句，非行号
                indent = results[4]
                with open(vulnerable_file_path, "r", encoding='utf-8') as f:
                    lines = f.readlines()
                # assert vulnerable_line == lines[line_number - start_line]
                if p_id not in vul_function:
                    vul_function[p_id] = {}
                elif v_id not in vul_function[p_id]:
                    vul_function[p_id][v_id] = []
                else:
                    vul_function[p_id][v_id].append({
                        "vulnerable_line": vulnerable_line,
                        "ground_truth_line": lines[line_number - 1],
                        'function': results,
                    })
print(vul_function)
with open('vul_function.json', 'w') as f:
    f.write(json.dumps(vul_function, indent=4, ensure_ascii=False))
