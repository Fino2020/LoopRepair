@@ -939,6 +939,7 @@
 	return(0);
 }
 
+
 static int
 TIFFWriteDirectoryTagSampleformatArray(TIFF* tif, uint32* ndir, TIFFDirEntry* dir, uint16 tag, uint32 count, double* value)
 {
@@ -946,7 +947,7 @@
 	void* conv;
 	uint32 i;
 	int ok;
-	conv = _TIFFmalloc(count*sizeof(double));
+	conv = _TIFFmalloc(count * sizeof(double));
 	if (conv == NULL)
 	{
 		TIFFErrorExt(tif->tif_clientdata, module, "Out of memory");
@@ -956,55 +957,111 @@
 	switch (tif->tif_dir.td_sampleformat)
 	{
 		case SAMPLEFORMAT_IEEEFP:
-			if (tif->tif_dir.td_bitspersample<=32)
+			if (tif->tif_dir.td_bitspersample <= 32)
 			{
 				for (i = 0; i < count; ++i)
+				{
+					if (value[i] < -3.402823466e+38 || value[i] > 3.402823466e+38)
+					{
+						_TIFFfree(conv);
+						TIFFErrorExt(tif->tif_clientdata, module, "Value out of range for float");
+						return (0);
+					}
 					((float*)conv)[i] = (float)value[i];
-				ok = TIFFWriteDirectoryTagFloatArray(tif,ndir,dir,tag,count,(float*)conv);
+				}
+				ok = TIFFWriteDirectoryTagFloatArray(tif, ndir, dir, tag, count, (float*)conv);
 			}
 			else
 			{
-				ok = TIFFWriteDirectoryTagDoubleArray(tif,ndir,dir,tag,count,value);
+				ok = TIFFWriteDirectoryTagDoubleArray(tif, ndir, dir, tag, count, value);
 			}
 			break;
 		case SAMPLEFORMAT_INT:
-			if (tif->tif_dir.td_bitspersample<=8)
+			if (tif->tif_dir.td_bitspersample <= 8)
 			{
 				for (i = 0; i < count; ++i)
+				{
+					if (value[i] < -128 || value[i] > 127)
+					{
+						_TIFFfree(conv);
+						TIFFErrorExt(tif->tif_clientdata, module, "Value out of range for int8");
+						return (0);
+					}
 					((int8*)conv)[i] = (int8)value[i];
-				ok = TIFFWriteDirectoryTagSbyteArray(tif,ndir,dir,tag,count,(int8*)conv);
+				}
+				ok = TIFFWriteDirectoryTagSbyteArray(tif, ndir, dir, tag, count, (int8*)conv);
 			}
-			else if (tif->tif_dir.td_bitspersample<=16)
+			else if (tif->tif_dir.td_bitspersample <= 16)
 			{
 				for (i = 0; i < count; ++i)
+				{
+					if (value[i] < -32768 || value[i] > 32767)
+					{
+						_TIFFfree(conv);
+						TIFFErrorExt(tif->tif_clientdata, module, "Value out of range for int16");
+						return (0);
+					}
 					((int16*)conv)[i] = (int16)value[i];
-				ok = TIFFWriteDirectoryTagSshortArray(tif,ndir,dir,tag,count,(int16*)conv);
+				}
+				ok = TIFFWriteDirectoryTagSshortArray(tif, ndir, dir, tag, count, (int16*)conv);
 			}
 			else
 			{
 				for (i = 0; i < count; ++i)
+				{
+					if (value[i] < -2147483648 || value[i] > 2147483647)
+					{
+						_TIFFfree(conv);
+						TIFFErrorExt(tif->tif_clientdata, module, "Value out of range for int32");
+						return (0);
+					}
 					((int32*)conv)[i] = (int32)value[i];
-				ok = TIFFWriteDirectoryTagSlongArray(tif,ndir,dir,tag,count,(int32*)conv);
+				}
+				ok = TIFFWriteDirectoryTagSlongArray(tif, ndir, dir, tag, count, (int32*)conv);
 			}
 			break;
 		case SAMPLEFORMAT_UINT:
-			if (tif->tif_dir.td_bitspersample<=8)
+			if (tif->tif_dir.td_bitspersample <= 8)
 			{
 				for (i = 0; i < count; ++i)
+				{
+					if (value[i] < 0 || value[i] > 255)
+					{
+						_TIFFfree(conv);
+						TIFFErrorExt(tif->tif_clientdata, module, "Value out of range for uint8");
+						return (0);
+					}
 					((uint8*)conv)[i] = (uint8)value[i];
-				ok = TIFFWriteDirectoryTagByteArray(tif,ndir,dir,tag,count,(uint8*)conv);
+				}
+				ok = TIFFWriteDirectoryTagByteArray(tif, ndir, dir, tag, count, (uint8*)conv);
 			}
-			else if (tif->tif_dir.td_bitspersample<=16)
+			else if (tif->tif_dir.td_bitspersample <= 16)
 			{
 				for (i = 0; i < count; ++i)
+				{
+					if (value[i] < 0 || value[i] > 65535)
+					{
+						_TIFFfree(conv);
+						TIFFErrorExt(tif->tif_clientdata, module, "Value out of range for uint16");
+						return (0);
+					}
 					((uint16*)conv)[i] = (uint16)value[i];
-				ok = TIFFWriteDirectoryTagShortArray(tif,ndir,dir,tag,count,(uint16*)conv);
+				}
+				ok = TIFFWriteDirectoryTagShortArray(tif, ndir, dir, tag, count, (uint16*)conv);
 			}
 			else
 			{
 				for (i = 0; i < count; ++i)
+				{
+					if (value[i] < 0 || value[i] > 4294967295)
+					{
+						_TIFFfree(conv);
+						TIFFErrorExt(tif->tif_clientdata, module, "Value out of range for uint32");
+						return (0);
+					}
 					((uint32*)conv)[i] = (uint32)value[i];
-				ok = TIFFWriteDirectoryTagLongArray(tif,ndir,dir,tag,count,(uint32*)conv);
+				}
+				ok = TIFFWriteDirectoryTagLongArray(tif, ndir, dir, tag, count, (uint32*)conv);
 			}
 			break;
 		default:
@@ -1015,6 +1072,7 @@
 	return (ok);
 }
 
+
 #if 0
 static int
 TIFFWriteDirectoryTagSampleformatPerSample(TIFF* tif, uint32* ndir, TIFFDirEntry* dir, uint16 tag, double value)
