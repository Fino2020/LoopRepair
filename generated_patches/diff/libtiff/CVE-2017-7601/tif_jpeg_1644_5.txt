@@ -1571,6 +1571,7 @@
 	return (1);
 }
 
+
 static int
 JPEGSetupEncode(TIFF* tif)
 {
@@ -1641,7 +1642,7 @@
 			if (!TIFFGetField(tif, TIFFTAG_REFERENCEBLACKWHITE,
 					  &ref)) {
 				float refbw[6];
-				long top = 1L << td->td_bitspersample;
+				long top = (td->td_bitspersample == 8) ? 255 : (td->td_bitspersample == 12) ? 4095 : 0;
 				refbw[0] = 0;
 				refbw[1] = (float)(top-1L);
 				refbw[2] = (float)(top>>1);
@@ -1735,6 +1736,7 @@
 	return (1);
 }
 
+
 /*
  * Set encoding state at the start of a strip or tile.
  */
